<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order-Form</title>
    <link rel="stylesheet" type="text/css" href="/static/css/style.css">

</head>
<body>
  <h1>申し込みフォーム</h1>
    <p>注文情報を記入ください</p>
        <div class="box_con" id="form">
            
            <table class="formTable">

              <tr>
                <th>UserID</th>
                <td><input type="text" name="userid" id="UserID" ></td>
              </tr>

              <tr>
                <th>集荷日時__</th>
                <td><input type="datetime-local" name="PickupDatetime" id="PickupDatetime"/></td>
              </tr>

              <tr>
                <th>着荷日時__</th>
                <td><input type="datetime-local" name="ArrivalDatetime" id="ArrivalDatetime"/></td>
              </tr>

              <tr>
                <th>集荷場所_住所__</th>
                  <td>
                    <p>郵便番号<input type="text" id="postalCode_pick" name="postalCode_pick"></p>
                      <select name="prefNname_pick" id="prefNname_pick">
                        <option value="" selected>都道府県</option>
                        <option value="東京都">東京都</option>
                        <option value="神奈川県">神奈川県</option>
                        <option value="千葉県">千葉県</option>
                        <option value="埼玉県">埼玉県</option>
                        <option value="茨城県">茨城県</option>
                        <option value="栃木県">栃木県</option>
                        <option value="群馬県">群馬県</option>
                        <option value="新潟県">新潟県</option>
                      </select>
                    <p>市区町村<input type="text" id="Locality_pick" name="Locality_pick"></p>
                    <p>町域・番地<input type="text" id="AddressLine_pick" name="AddressLine_pick"></p>
                    <p>建物名<input type="text" id="BuildingName_pick" name="BuildingName_pick"></p>
                    <p>バースNo.<input type="text" id="berth_pick" name="berth_pick"></p>
                  </td>
              </tr>
              
              <tr>
                <th><p></p></th>
                <td><p>---------------------------------------</p></td>
              </tr>

              <tr>
                <th>着荷場所_住所__</th>
                  <td>
                    <p>郵便番号<input type="text" id="postalCode_arrival" name="postalCode_arrival"></p>
                      <select name="prefNname_arrival" id="prefNname_arrival">
                        <option value="" selected>都道府県</option>
                        <option value="東京都">東京都</option>
                        <option value="神奈川県">神奈川県</option>
                        <option value="千葉県">千葉県</option>
                        <option value="埼玉県">埼玉県</option>
                        <option value="茨城県">茨城県</option>
                        <option value="栃木県">栃木県</option>
                        <option value="群馬県">群馬県</option>
                        <option value="新潟県">新潟県</option>
                      </select>
                    <p>市区町村<input type="text" id="Locality_arrival" name="Locality_arrival"></p>
                    <p>町域・番地<input type="text" id="AddressLine_arrival" name="AddressLine_arrival"></p>
                    <p>建物名<input type="text" id="BuildingName_arrival" name="BuildingName_arrival"></p>
                    <p>バースNo.<input type="text" id="berth_arrival" name="berth_arrival"></p>
                  </td>
              </tr>

              <tr>
                <th>距離算出</th>
                <td><p id="distance">ここに距離が出ます</p></td>
              </tr>

              <tr>
                <th>車格__</th>
                <td><select name="TruckSize" id="TruckSize">
                    <option value="" name="none">選択してください</option>
                    <option value= 1 >{{ .TruckSizeSmall }}</option>
                    <option value= 2 >{{ .TruckSizeTowTon }}</option>
                    <option value= 3 >{{ .TruckSizeFourTon }}</option>
                    <option value= 4 >{{ .TruckSizeTenTon }}</option>
                  </select></td>
              </tr>

              <tr>
                <th>料金__</th>
                <td><input size="20" type="text" name="Price" id="Price"/></td>
              </tr> 

              <tr>
                <th>発注日__</th>
                <td><input type="date" name="OrderDatetime" min="2022-12-01" max="2026-02-09" id="OrderDatetime"/></td>
              </tr>

            </table>
            
              <div clacc="box_check"></div>
                <label>
                    <input type="checkbox" name="acceptance-714" value="1" aria-invalid="false" class="agree"><span class="check">プライバシーポリシーに同意する</span>
                </label>
            </div> 
            <p class="btn">
                <span><input type="submit" value="確認" id="runSet"/></span>
            </p>

        </div>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script> 
  <script src='https://www.bing.com/api/maps/mapcontrol?callback=GetMap&key=AokHgh1grGCr3EDpuzGtpVGzME_umX7tE4TZqtjwd2yX4kyeVdRR71-FMiWzmJJg' async defer></script>
  <script type="text/javascript">

      $("#runSet").on("click",function(){
        const address_url ="https://dev.virtualearth.net/REST/v1/Locations?"

        // 住所取得 pickup
        const address_params_pick = {
          "CountryRegion":"JP",
          "PostalCode":document.getElementById('postalCode_pick').value,
          "AdminDistrict":document.getElementById('prefNname_pick').value,
          "Locality":document.getElementById('Locality_pick').value,
          "AddressLine":document.getElementById('AddressLine_pick').value,
          "key": "AokHgh1grGCr3EDpuzGtpVGzME_umX7tE4TZqtjwd2yX4kyeVdRR71-FMiWzmJJg"
        };
        // console.log(address_params_pick);

          let geolcation_pickup ;
          var xhr_pic = new XMLHttpRequest();
          xhr_pic.open("GET", address_url + "?" + new URLSearchParams(address_params_pick).toString(),false);
          xhr_pic.onreadystatechange = function() {
            if (xhr_pic.readyState === 4 && xhr_pic.status === 200) {
              var response = JSON.parse(xhr_pic.responseText);
              // console.log(response);
              let lat = response.resourceSets[0].resources[0].bbox[0];
              let lon = response.resourceSets[0].resources[0].bbox[1];
              geolcation_pickup = lat+","+lon;
              console.log(geolcation_pickup);
              // document.getElementById("show_address_pick").innerHTML = "The address is " + geolcation_pickup;
            }
          };
          xhr_pic.send();

        // 住所取得 arrival
        const address_params_arrival = {
          "CountryRegion":"JP",
          "PostalCode":document.getElementById('postalCode_arrival').value,
          "AdminDistrict":document.getElementById('prefNname_arrival').value,
          "Locality":document.getElementById('Locality_arrival').value,
          "AddressLine":document.getElementById('AddressLine_arrival').value,
          "key": "AokHgh1grGCr3EDpuzGtpVGzME_umX7tE4TZqtjwd2yX4kyeVdRR71-FMiWzmJJg"
        };

        let geolcation_arrival;
        var distance;
        var xhr_arr = new XMLHttpRequest();
        xhr_arr.open("GET", address_url + "?" + new URLSearchParams(address_params_arrival).toString(),false);
        xhr_arr.onreadystatechange = function() {
          
          if (xhr_arr.readyState === 4 && xhr_arr.status === 200) {
            var response = JSON.parse(xhr_arr.responseText);

            let lat = response.resourceSets[0].resources[0].bbox[0];
            let lon = response.resourceSets[0].resources[0].bbox[1];
            geolcation_arrival =lat+","+lon;
            console.log(geolcation_arrival);
            // document.getElementById("show_address_arr").innerHTML = "The address is " + geolcation_arrival;
          }
        };

        xhr_arr.send();

        // 距離算出
        var distance;
        setTimeout(function() {
          const url = "https://dev.virtualearth.net/REST/v1/Routes/Driving";
          const params = {       
            "key": "AokHgh1grGCr3EDpuzGtpVGzME_umX7tE4TZqtjwd2yX4kyeVdRR71-FMiWzmJJg",
            "wp.0": geolcation_pickup,
            "wp.1": geolcation_arrival,
          };

          var xhr = new XMLHttpRequest();
          xhr.open("GET", url + "?" + new URLSearchParams(params).toString(),false);
          xhr.onreadystatechange = function() {
            if (xhr.readyState === 4 && xhr.status === 200) {
              var response = JSON.parse(xhr.responseText);
              // console.log(response);
              distance = response.resourceSets[0].resources[0].routeLegs[0].travelDistance;
              distance = Math.floor(distance * 1000) // meterに変換
              document.getElementById("distance").innerHTML = "The distance between the two points is " + (distance/1000).toFixed(2) + " km";
              post_to_server();
            }
          };
          xhr.send();
        }, 1000);


        function writeData(){
          data = {
            "UserID": Number(document.getElementById('UserID').value),
            "PickupDatetime":new Date(document.getElementById('PickupDatetime').value),
            "ArrivalDatetime":new Date(document.getElementById('ArrivalDatetime').value),
            "PickupLocation":[address_params_pick.PostalCode,
                              address_params_pick.AdminDistrict,
                              address_params_pick.Locality,
                              address_params_pick.AddressLine,
                              document.getElementById('BuildingName_pick').value,
                              document.getElementById('berth_pick').value
                            ],
            "ArrivalLocation":[address_params_arrival.PostalCode,
                               address_params_arrival.AdminDistrict,
                               address_params_arrival.Locality,
                               address_params_arrival.AddressLine,
                               document.getElementById('BuildingName_arrival').value,
                               document.getElementById('berth_arrival').value
                              ],

            "OrderDatetime":document.getElementById('OrderDatetime').value,
            "TruckSize":Number(document.getElementById('TruckSize').value),
            "Price":document.getElementById('Price').value,
            "Mileage":distance,
          }
          return data
        }

        function post_to_server() {
          data = writeData()
          $.ajax({
                type: 'POST',
                // url: 'https://ourcargo-platform.com/orderpage', EC2 deploy時に使用
                url: 'http://localhost:8080/orderpage',
                contentType: 'application/json',
                data: JSON.stringify(data),  // access in body
                // success: alert("success"),
          });
          console.log(data);
        };            
      })

</script>

</body>
</html>